<html>
	<body>
		<button onclick="input.click()">Browse for hex file.</button>
		<pre id="demo"></pre>

</div>
	</body>
	<script>
		var input = document.createElement('input');
		input.type = 'file';
		input.accept = ".hex";
		input.click();
		
		input.onchange = e => { 
			const MAX_JSON_PART_LENGTH = 18000; //Max bytes per POST to writememory.
			const JSON_DATA_ELEMENT_OVERHEAD = 26; //bytes used up for each data element by tag names, colons, and other formatting.
			var file = e.target.files[0]; 		
			var reader = new FileReader();
			reader.readAsText(file,'UTF-8');
			reader.onload = readerEvent => {
				var filename = input.value.replace(/^.*\\/, ""); //strip path from filename
				var content = readerEvent.target.result; //hex file contents as string
				var header_id = {
					addr : "0000",
					data : getAsciiHexString("#!200EFU") 
				}
				var card_i2c_address = {
					addr : "0008",
					data : "a0"
				}
				var chip_count = {
					addr : "0009",
					data : "01"
				}
				var chip_size = {
					addr : "000a",
					data : "ffff"
				}
				var toc_start = {
					addr : "000c",
					data : "A00010"
				}
				var termination1 = {
					addr : "000f",
					data : "00"
				}
				var bang = {
					addr : "0010",
					data : getAsciiHexString("!") 
				}
				var module_name = {
					addr : "0011",
					data : getAsciiHexString(filename.substring(0,4)) //get from filename, convert to hex
				}
				var hardware_version = {
					addr : "0015",
					data : "0001" 
				}
				var firmware_version = {
					addr : "0017",
					data : getFirmwareVersion(filename) //get from filename
				}
				var hex_start_i2c_address = {
					addr : "0019",
					data : "a0" 
				}
				var hex_start_address = {
					addr : "001a",
					data : "0050"
				}
				var hex_end_i2c_address = {
					addr : "001c",
					data : "a0" 
				}
				var hex_end_address = {
					addr : "001d",
					data : "" //calculated below.
				}
				var termination2 = {
					addr : "001f",
					data : "00"
				}
							
				var firmwareImage = [];
				var firmwareImagePart = [];
				firmwareImage.push(firmwareImagePart);
			
				if (!filenameIsV2(filename)) {
				//This is the V1 case.
					firmwareImagePart.push(header_id);
					firmwareImagePart.push(card_i2c_address);
					firmwareImagePart.push(chip_count);
					firmwareImagePart.push(chip_size);
					firmwareImagePart.push(toc_start);
					firmwareImagePart.push(termination1);
					firmwareImagePart.push(bang);
					firmwareImagePart.push(module_name);
					firmwareImagePart.push(hardware_version);
					firmwareImagePart.push(firmware_version);
					firmwareImagePart.push(hex_start_i2c_address);
					firmwareImagePart.push(hex_start_address);
					firmwareImagePart.push(hex_end_i2c_address);
					firmwareImagePart.push(hex_end_address);
					firmwareImagePart.push(termination2);
					
					var lines = content.split(":");	
					var address = 0x50; //Starts at 0x50 in V1.
					var datacount = 0;
					for(var i = 1;i < lines.length;i++){ //Start at 1 because split on colon gives null result first time.
						firmwareImagePart.push(getJsonFromLine(address,lines[i]));
						address = address + lines[i].length - 1;
						datacount = datacount + firmwareImagePart[firmwareImagePart.length - 1].data.length;
						if ((datacount + JSON_DATA_ELEMENT_OVERHEAD  * firmwareImagePart.length)> MAX_JSON_PART_LENGTH){
						//POST data size limited to 20k. Split into parts.
							firmwareImagePart = [];
							firmwareImage.push(firmwareImagePart);
							datacount = 0;
						}
					}
					hex_end_address.data = (address).toString(16); //Now that last address is known, update data. 	
				} else {
					//This is the V2 case.
					header_id.data =  getAsciiHexString("#$200EFU");  
					var version = {
						addr : "0008",
						data: "02"
					}
					card_i2c_address.addr = "0009";
					chip_count.addr = "000a";
					chip_size.addr = "000b";
					chip_size.data = "0003ffff"; //FRAM has 18 bit address.
					module_name.addr = "000f";
					hardware_version.addr = "0013";
					firmware_version.addr = "0015";
					var firmware_size = {
						addr : "0017",
						data: "" //calculated below.
					}
					firmwareImagePart.push(header_id);
					firmwareImagePart.push(version);
					firmwareImagePart.push(card_i2c_address);
					firmwareImagePart.push(chip_count);
					firmwareImagePart.push(chip_size);
					firmwareImagePart.push(module_name);
					firmwareImagePart.push(hardware_version);
					firmwareImagePart.push(firmware_version);
					firmwareImagePart.push(firmware_size);
					
					var lines = content.split(":");	
					var address = 0x2B;  //Starts at 0x2B in V2.
					var datacount = 0;
					for(var i = 1;i < lines.length;i++){ //Start at 1 because split on colon gives null result first time.
						firmwareImagePart.push(getJsonFromLine(address,lines[i]));
						address = address + lines[i].length - 1;
						datacount = datacount + firmwareImagePart[firmwareImagePart.length - 1].data.length;
						if ((datacount + JSON_DATA_ELEMENT_OVERHEAD  * firmwareImagePart.length)> MAX_JSON_PART_LENGTH){
						//POST data size limited to 20k. Split into parts.
							firmwareImagePart = [];
							firmwareImage.push(firmwareImagePart);
							datacount = 0;
						}
					}
					var total_size = (address - 0x2B).toString(16); //Now that last address is known, update data. 
					firmware_size.data = total_size.padStart(8,'0'); // Zero pad to eight characters.
				}
				var request = new XMLHttpRequest();
				for(var i = 0;i < firmwareImage.length;i++){
					//Send each firmwareImage part
					var firmwareImagePartString = JSON.stringify(firmwareImage[i],undefined,2);
					request.open("POST", "http://192.168.0.1/writememory", false); //Seems synchronous (false) is needed here, right?
					request.setRequestHeader("Content-Length", firmwareImagePartString.length);
					request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
					request.send(firmwareImagePartString);
				}
				document.getElementById("demo").innerHTML = "Firmare successfully uploaded to preset manager."
			}
		}
		
		function getAsciiHexString(text) {
		  var result = "";
		  var i;
		  for (i = 0; i < text.length; i++){
			result = result + text[i].charCodeAt(0).toString(16); 
		  }
		  return result;
		}
		
		function filenameIsV2(filename){
			var module_id = filename.substring(0,4);
			var result = true;
			switch(module_id) {
			  case "296E": {break;}
			  case "251E": {break;}
			  case "257E": {break;}
			  case "267E": {break;}
			  case "218E": {break;}
			  case "252E": {break;}
			  case "225H": {break;}
			  case "226H": {break;}
			  case "222E": {break;}
			  case "223M": {break;}
			  case "261E": {break;}
			  case "225S": {break;}
			  case "225E": {break;}
			  default: {result = false;}
			}
			return result;
		}
		
		
		function getFirmwareVersion(filename) {
			//The firmware version is one to three numbers between "v" and ".hex"
			//Always output the first two, padding with "0" if necessary.
			var result = "0000";
			var v_index = filename.lastIndexOf("v");
			var dot_index = filename.lastIndexOf(".hex");
			result = filename.substring(v_index + 1,dot_index);
			if (result.length == 1){
				result = "0" + result;
			} else if (result.length == 3) {
				result = result.substring(0,2);
			}
			result = "0" + result.substring(0,1) + "0" + result.substring(1,2);
			return result;
		}
		
		function getJsonFromLine(address,line){
			var tmp = "3a";
			line = line.replace(/^\s+|\s+$/gm,'');
			for(var i = 0;i < line.length;i++){
				var digit = parseInt(line[i],16);
				//Not sure what is going on, but each 
				//character in the file expands to a 
				//byte in the following way.
				if (digit < 0xA) {
					digit = digit + 0x30;
				} else {
					digit = digit + 0x37;
				}
				tmp = tmp + digit.toString(16);
			}
			var result = {
				addr : address.toString(16),
				data : tmp 
			}
			return result;
		}
		
		
	</script>
</html>
