<html>
	<body>
		<button onclick="input.click()">Browse for hex file.</button>
		<pre id="demo"></pre>

</div>
	</body>
	<script>
		var url = "http://192.168.0.1/writememory";
		var method = "POST";
		var shouldBeAsync = false;
		var request = new XMLHttpRequest();
	
		var input = document.createElement('input');
		input.type = 'file';
		input.accept = ".hex";
		input.click();
		
		input.onchange = e => { 
			var file = e.target.files[0]; 		
			var reader = new FileReader();
			reader.readAsText(file,'UTF-8');
			reader.onload = readerEvent => {
				var filename = input.value.replace(/^.*\\/, ""); //strip path from filename
				var content = readerEvent.target.result; //hex file contents as string
				var header_id = {
					addr : "0000",
					data : getAsciiHexString("#!200EFU") 
				}
				var card_i2c_address = {
					addr : "0008",
					data : "a0"
				}
				var chip_count = {
					addr : "0009",
					data : "01"
				}
				var chip_size = {
					addr : "000a",
					data : "ffff"
				}
				var toc_start = {
					addr : "000c",
					data : "A00010"
				}
				var termination1 = {
					addr : "000f",
					data : "00"
				}
				var bang = {
					addr : "0010",
					data : getAsciiHexString("!") 
				}
				var module_name = {
					addr : "0011",
					data : getAsciiHexString(filename.substring(0,4)) //get from filename, convert to hex
				}
				var hardware_version = {
					addr : "0015",
					data : "0001" 
				}
				var firmware_version = {
					addr : "0017",
					data : getFirmwareVersion(filename) //get from filename
				}
				var hex_start_i2c_address = {
					addr : "0019",
					data : "a0" 
				}
				var hex_start_address = {
					addr : "001a",
					data : "0050"
				}
				var hex_end_i2c_address = {
					addr : "001c",
					data : "a0" 
				}
				var hex_end_address = {
					addr : "001d",
					data : "" //calculated below.
				}
				var termination2 = {
					addr : "001f",
					data : "00"
				}
							
				var V1FirmwareImage = [];
				var V2FirmwareImage = [];
				var jsonAll = "";
			
				if (!filenameIsV2(filename)) {
					V1FirmwareImage.push(header_id);
					V1FirmwareImage.push(card_i2c_address);
					V1FirmwareImage.push(chip_count);
					V1FirmwareImage.push(chip_size);
					V1FirmwareImage.push(toc_start);
					V1FirmwareImage.push(termination1);
					V1FirmwareImage.push(bang);
					V1FirmwareImage.push(module_name);
					V1FirmwareImage.push(hardware_version);
					V1FirmwareImage.push(firmware_version);
					V1FirmwareImage.push(hex_start_i2c_address);
					V1FirmwareImage.push(hex_start_address);
					V1FirmwareImage.push(hex_end_i2c_address);
					V1FirmwareImage.push(hex_end_address);
					V1FirmwareImage.push(termination2);
					
					var lines = content.split(":");	
					var address = 0x50;
					for(var i = 1;i < lines.length;i++){ //Start at 1 because split on colon gives null result first time.
						V1FirmwareImage.push(getJsonFromLine(address,lines[i]));
						address = address + lines[i].length - 1;
						if ((i%135 == 0) && (i != (lines.length - 1))){
						//POST data size limited to 20k. Splitting every 135 lines creates 17k chunks on average.
							V1FirmwareImage.push("pagebreak");
						}
					}
					hex_end_address.data = (address).toString(16); //Now that last address is known, update data. 
					jsonAll = JSON.stringify(V1FirmwareImage, undefined, 2);
					lines = undefined; //free memory?
					V1FirmwareImage = undefined; //free memory?
					
				} else {
					//Now V2 stuff
					header_id.data =  getAsciiHexString("#$200EFU");  
					var version = {
						addr : "0008",
						data: "02"
					}
					card_i2c_address.addr = "0009";
					chip_count.addr = "000a";
					chip_size.addr = "000b";
					chip_size.data = "0003ffff"; //FRAM has 18 bit address.
					module_name.addr = "000f";
					hardware_version.addr = "0013";
					firmware_version.addr = "0015";
					var firmware_size = {
						addr : "0017",
						data: "" //calculated below.
					}
					V2FirmwareImage.push(header_id);
					V2FirmwareImage.push(version);
					V2FirmwareImage.push(card_i2c_address);
					V2FirmwareImage.push(chip_count);
					V2FirmwareImage.push(chip_size);
					V2FirmwareImage.push(module_name);
					V2FirmwareImage.push(hardware_version);
					V2FirmwareImage.push(firmware_version);
					V2FirmwareImage.push(firmware_size);
					
					var lines = content.split(":");	
					var address = 0x2B;  //Starts at 0x2B in V2.
					for(var i = 1;i < lines.length;i++){ //Start at 1 because split on colon gives null result first time.
						V2FirmwareImage.push(getJsonFromLine(address,lines[i]));
						address = address + lines[i].length - 1;
						if ((i%135 == 0) && (i != (lines.length - 1))){
						    //POST data size limited to 20k. Splitting every 135 lines creates 17k chunks on average.
							V2FirmwareImage.push("pagebreak");
						}
					}
					var total_size = (address - 0x2B).toString(16); //Now that last address is known, update data. 
					firmware_size.data = total_size.padStart(8,'0'); // Zero pad to eight characters.
					jsonAll = JSON.stringify(V2FirmwareImage, undefined, 2);
					lines = undefined; //free memory?
					V2FirmwareImage = undefined; //free memory?
				}
				
				var responseString = "";
				var jsonPart = jsonAll.split("\"pagebreak\""); //Max post size is 20k. Split into smaller pieces.
				for(var i = 0;i < jsonPart.length;i++){
					//Fix up split JSON (not necessary, but makes it look good in case anyone sees it.)
					jsonPart[i] = jsonPart[i].trim();
					jsonPart[i] = jsonPart[i].substring(0,jsonPart[i].length - 1) + "]";
					if (jsonPart[i].substring(0,1) == ","){
						jsonPart[i] = jsonPart[i].replace(",","[");
					}
					//Send the JSON part
					request.open(method, url, shouldBeAsync);
					request.setRequestHeader("Content-Length", jsonPart[i].length);
					request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
					request.send(jsonPart[i]);
					responseString = responseString + request.responseText;
				}
				//document.getElementById("demo").innerHTML = responseString;
				document.getElementById("demo").innerHTML = "Firmare successfully uploaded to preset manager."
			}
		}
		
		function getAsciiHexString(text) {
		  var result = "";
		  var i;
		  for (i = 0; i < text.length; i++){
			result = result + text[i].charCodeAt(0).toString(16); 
		  }
		  return result;
		}
		
		function filenameIsV2(filename){
			var module_id = filename.substring(0,4);
			var result = true;
			switch(module_id) {
			  case "296E": {break;}
			  case "251E": {break;}
			  case "257E": {break;}
			  case "267E": {break;}
			  case "218E": {break;}
			  case "252E": {break;}
			  case "225H": {break;}
			  case "226H": {break;}
			  case "222E": {break;}
			  case "223M": {break;}
			  case "261E": {break;}
			  case "225S": {break;}
			  case "225E": {break;}
			  default: {result = false;}
			}
			return result;
		}
		
		
		function getFirmwareVersion(filename) {
			//The firmware version is one to three numbers between "v" and ".hex"
			//Always output the first two, padding with "0" if necessary.
			var result = "0000";
			var v_index = filename.lastIndexOf("v");
			var dot_index = filename.lastIndexOf(".hex");
			result = filename.substring(v_index + 1,dot_index);
			if (result.length == 1){
				result = "0" + result;
			} else if (result.length == 3) {
				result = result.substring(0,2);
			}
			result = "0" + result.substring(0,1) + "0" + result.substring(1,2);
			return result;
		}
		
		function getJsonFromLine(address,line){
			var tmp = "3a";
			line = line.replace(/^\s+|\s+$/gm,'');
			for(var i = 0;i < line.length;i++){
				var digit = parseInt(line[i],16);
				//Not sure what is going on, but each 
				//character in the file expands to a 
				//byte in the following way.
				if (digit < 0xA) {
					digit = digit + 0x30;
				} else {
					digit = digit + 0x37;
				}
				tmp = tmp + digit.toString(16);
			}
			var result = {
				addr : address.toString(16),
				data : tmp 
			}
			return result;
		}
		
		
	</script>
</html>
