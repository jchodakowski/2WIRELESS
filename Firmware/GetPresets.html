<html>
	<body>
		<p id="title" style="font-family:'Arial';font-size:16px">
				Fetch Presets from Module		
		</p>
		<button id="button">Fetch Presets</button>
		<select id="module">
			<option value="Select">Select....</option>
			<option value="0x60">206e</option>
			<option value="0x63">207e</option>
			<option value="0x20">210e</option>
			<option value="0x70">218e</option>
			<option value="0x40">222e A</option>
			<option value="0x5A">223e M</option>
			<option value="0x5B">223e A</option>
			<option value="0x21">225e</option>
			<!-- <option value="0x22">225s</option> -->
			<option value="0x23">227e</option>
			<option value="0x66">230e A</option>
			<option value="0x67">230e B</option>
			<option value="0x68">230e C</option>
			<option value="0x69">230e D</option>
			<option value="0x24">249e A</option>
			<option value="0x25">249e B</option>
			<option value="0x41">250e A</option>
			<option value="0x42">250e B</option>
			<option value="0x5C">251e A</option>
			<option value="0x5F">252e A</option>
			<option value="0x34">256e A1</option>
			<option value="0x36">256e A2</option>
			<option value="0x35">256e B1</option>
			<option value="0x37">256e B2</option>
			<option value="0x10">257e A</option>
			<option value="0x11">257e B</option>
			<option value="0x28">259e A</option>
			<option value="0x29">259e B</option>
			<option value="0x2A">259e C</option>
			<option value="0x2B">259e D</option>
			<option value="0x30">260e A</option>
			<option value="0x31">260e B</option>
			<option value="0x2C">261e A</option>
			<option value="0x2D">261e B</option>
			<option value="0x2E">261e C</option>
			<option value="0x2F">261e D</option>
			<option value="0x32">266e A</option>
			<option value="0x33">266e B</option>
			<option value="0x12">267e A</option>
			<option value="0x13">267e B</option>
			<option value="0x5E">272e</option>
			<option value="0x38">281e A1</option>
			<option value="0x39">281e A2</option>
			<option value="0x3A">281e B1</option>
			<option value="0x3B">281e B2</option>
			<option value="0x3C">281e C1</option>
			<option value="0x3D">281e C2</option>
			<option value="0x3E">281e D1</option>
			<option value="0x3F">281e D2</option>
			<option value="0x4C">285e A1</option>
			<option value="0x4D">285e B1</option>
			<option value="0x4E">285e A2</option>
			<option value="0x4F">285e B2</option>
			<option value="0x44">291e A</option>
			<option value="0x45">291e B</option>
			<option value="0x48">292e A</option>
			<option value="0x49">292e B</option>
			<option value="0x4A">292e C</option>
			<option value="0x4B">292e D</option>
			<option value="0x64">296e A</option>
			<option value="0x65">296e B</option>
			<option value="0x20">Studio H 210e</option>
			<option value="0x35">Studio H 254e A</option>
			<option value="0x37">Studio H 254e B</option>
			<option value="0x10">Studio H 255e A</option>
			<option value="0x11">Studio H 255e B</option>
			<option value="0x28">Studio H DPO (259e) A</option>
			<option value="0x29">Studio H DPO (259e) B</option>
			<option value="0x2A">Studio H DPO (259e) C</option>
			<option value="0x2B">Studio H DPO (259e) D</option>
			<option value="0x2C">Studio H DPO (261e) A</option>
			<option value="0x2D">Studio H DPO (261e) B</option>
			<option value="0x2E">Studio H DPO (261e) C</option>
			<option value="0x2F">Studio H DPO (261e) D</option>
			<option value="0x72">226h</option>
		</select>
		<p id="result" style="font-family:'Arial';font-size:12px"></p>
	</body>
	<script>
		//This script retrieves raw preset data from the module and processes it. 
		//The processed data is then displayed on the page. The processed data is 
		//in the required JSON format for writing back to the module. (See SetPresets.html)
		//
		//Details:
		//The raw data has memory addresses embedded within it, and these addresses must be found
		//and separated from the preset data to produce the processed data. 
		//Each module is different, and the addresses are located using the dataskip[] values below.
		//The dataskip values were found by manual inspection of the raw data!
		const HTTP_REQUEST_TIMEOUT = 5000; 
		var module_address;
		var module_name;
		var url = "http://192.168.0.1/getpresets?addr=";
		var method = "GET";
		var shouldBeAsync = true;
		var request = new XMLHttpRequest();
		request.timeout = HTTP_REQUEST_TIMEOUT; // time in milliseconds
		request.onload = function () {
			var status = request.status; // HTTP response status, e.g., 200 for "200 OK"
			var data = request.responseText; // Returned data, e.g., an HTML document.
			//document.getElementById("result").innerHTML = data;
			var rawJsonMessage = JSON.parse(data);
			document.getElementById("result").innerHTML = rawJsonMessage.data;
			document.getElementById("result").innerHTML = "Done.";
			
			var refinedJson;
			var presetData = [];
			var dataskip = [];
			var i;
			
			if (module_name.indexOf("225e") == 0) {
				//225e every line is different.
				dataskip[0]=128;
				dataskip[1]=12;
				dataskip[2]=116;
				dataskip[3]=24;
				dataskip[4]=104;
				dataskip[5]=36;
				dataskip[6]=92;
				dataskip[7]=48;
				dataskip[8]=80;
				dataskip[9]=60;
				dataskip[10]=68;
				dataskip[11]=72;
				dataskip[12]=56;
				dataskip[13]=84;
				dataskip[14]=44;
				dataskip[15]=96;
				dataskip[16]=32;
				dataskip[17]=108;
				dataskip[18]=20;
				dataskip[19]=120;
				dataskip[20]=8;
				dataskip[21]=128;
				dataskip[22]=4;
				dataskip[23]=124;
				dataskip[24]=16;
				dataskip[25]=112;
				dataskip[26]=28;
				dataskip[27]=100;
				dataskip[28]=40;
				dataskip[29]=88;
				dataskip[30]=52;
				dataskip[31]=76;
				dataskip[32]=64;
				dataskip[33]=64;
				dataskip[34]=76;
				dataskip[35]=52;
				dataskip[36]=88;
				dataskip[37]=40;
				dataskip[38]=100;
				dataskip[39]=28;
				dataskip[40]=112;
				dataskip[41]=16;
				dataskip[42]=124;
				dataskip[43]=4;
				dataskip[44]=128;
				dataskip[45]=8;
				dataskip[46]=120;
				dataskip[47]=20;
				dataskip[48]=108;
				dataskip[49]=32;
				dataskip[50]=96;
				dataskip[51]=44;
				dataskip[52]=84;
				dataskip[53]=56;
				dataskip[54]=72;
				dataskip[55]=68;
				dataskip[56]=60;
				dataskip[57]=80;
				dataskip[58]=48;
				dataskip[59]=92;
				dataskip[60]=36;
				dataskip[61]=104;
			}
			
			else if (module_name.indexOf("251e") == 0) {
				//251e has 128 characters with some exceptions.
				for (i = 0; i < 1013; i++) {
					dataskip[i] = 128;
				}
				dataskip[32]=112;
				dataskip[33]=16;
				dataskip[66]=96;
				dataskip[67]=32;
				dataskip[100]=80;
				dataskip[101]=48;		
				dataskip[134]=64;	
				dataskip[135]=64;
				dataskip[168]=48;
				dataskip[169]=80;
				dataskip[202]=32;
				dataskip[203]=96;
				dataskip[236]=16;
				dataskip[237]=112;				
				dataskip[302]=112;
				dataskip[303]=16;
				dataskip[336]=96;
				dataskip[337]=32;
				dataskip[370]=80;
				dataskip[371]=48;
				dataskip[404]=64;
				dataskip[405]=64;
				dataskip[438]=48;
				dataskip[439]=80;
				dataskip[472]=32;
				dataskip[473]=96;
				dataskip[506]=16;
				dataskip[507]=112;
				dataskip[572]=112;
				dataskip[573]=16;
				dataskip[606]=96;
				dataskip[607]=32;
				dataskip[640]=80;
				dataskip[641]=48;
				dataskip[674]=64;
				dataskip[675]=64;
				dataskip[708]=48;
				dataskip[709]=80;
				dataskip[742]=32;
				dataskip[743]=96;
				dataskip[776]=16;
				dataskip[777]=112;
				dataskip[842]=112;
				dataskip[843]=16;
				dataskip[876]=96;
				dataskip[877]=32;
				dataskip[910]=80;
				dataskip[911]=48;
				dataskip[944]=64;
				dataskip[945]=64;
				dataskip[978]=48;
				dataskip[979]=80;
				dataskip[1012]=32;
			}
			
			else if (module_name.indexOf("254e") > -1) {
				//254e is 32.
				for (i = 0; i < 30; i++) {
					dataskip[i] = 32;
				}
			}
			
			else if (module_name.indexOf("255e") > -1) {
				//255e is mostly 72.
				//Note 255e data is packed. Each value is 12 bits, so bytes are shared to save space. 
				//Refer to CSR comments below. Same thing here except PRESET_LENGTH=24 and
				//PACKED_PRESET_LENGTH=18.
				for (i = 0; i < 38; i++) {
					dataskip[i] = 72;
				}
				dataskip[3]=40;
				dataskip[4]=32;
				dataskip[8]=8;
				dataskip[9]=64;
				dataskip[12]=48;
				dataskip[13]=24;
				dataskip[17]=16;
				dataskip[18]=56;
				dataskip[21]=56;
				dataskip[22]=16;
				dataskip[26]=24;
				dataskip[27]=48;
				dataskip[30]=64;
				dataskip[31]=8;
				dataskip[35]=32;
				dataskip[36]=40;
			}
			
			else if (module_name.indexOf("259e") == 0) {
				//259e has a pattern. Every third line is 66.
				for (i = 0; i < 45; i++) {
					dataskip[i] = 66;
				}
				dataskip[1] = 62;
				dataskip[2] = 4;
				dataskip[4] = 58;
				dataskip[5] = 8;
				dataskip[7] = 54;
				dataskip[8] = 12;
				dataskip[10] = 52;
				dataskip[11] = 14;
				dataskip[13] = 46;
				dataskip[14] = 20;
				dataskip[16] = 42;
				dataskip[17] = 24;
				dataskip[19] = 38;
				dataskip[20] = 28;
				dataskip[22] = 34;
				dataskip[23] = 32;
				dataskip[25] = 30;
				dataskip[26] = 36;
				dataskip[28] = 26;
				dataskip[29] = 40;
				dataskip[31] = 22;
				dataskip[32] = 44;
				dataskip[34] = 18;
				dataskip[35] = 48;
				dataskip[37] = 14;
				dataskip[38] = 52;
				dataskip[40] = 10;
				dataskip[41] = 56;
				dataskip[43] = 6;
				dataskip[44] = 60;
			}
			
			else if (module_name.indexOf("266e") == 0) {
				//266e is mostly 14.
				for (i = 0; i < 33; i++) {
					dataskip[i] = 14;
				}
				dataskip[9] = 2;
				dataskip[10] = 12;
				dataskip[19] = 4;
				dataskip[20] = 10;
				dataskip[29] = 6;
				dataskip[30] = 8;
			}
			
			else if (module_name.indexOf("281e") == 0) {
				//281e is mostly 14.
				for (i = 0; i < 33; i++) {
					dataskip[i] = 14;
				}
				dataskip[9] = 2;
				dataskip[10] = 12;
				dataskip[19] = 4;
				dataskip[20] = 10;
				dataskip[29] = 6;
				dataskip[30] = 8;
			}
			
			else if (module_name.indexOf("291e") == 0) {
				//291e has 128 characters with some exceptions.
				for (i = 0; i < 140; i++) {
					dataskip[i] = 128;
				}
				dataskip[3]=86;
				dataskip[4]=42;
				dataskip[8]=44;
				dataskip[9]=84;
				dataskip[13]=2;
				dataskip[14]=126;
				dataskip[17]=88;
				dataskip[18]=40;
				dataskip[22]=46;
				dataskip[23]=82;
				dataskip[27]=4;
				dataskip[28]=124;
				dataskip[31]=90;
				dataskip[32]=38;
				dataskip[36]=48;
				dataskip[37]=80;
				dataskip[41]=6;
				dataskip[42]=122;
				dataskip[45]=92;
				dataskip[46]=36;
				dataskip[50]=50;
				dataskip[51]=78;
				dataskip[55]=8;
				dataskip[56]=120;
				dataskip[59]=94;
				dataskip[60]=34;
				dataskip[64]=52;
				dataskip[65]=76;
				dataskip[69]=10;
				dataskip[70]=118;
				dataskip[73]=96;
				dataskip[74]=32;
				dataskip[78]=54;
				dataskip[79]=74;
				dataskip[83]=12;
				dataskip[84]=116;
				dataskip[87]=98;
				dataskip[88]=30;
				dataskip[92]=56;
				dataskip[93]=72;
				dataskip[97]=14;
				dataskip[98]=114;
				dataskip[101]=100;
				dataskip[102]=28;
				dataskip[106]=58;
				dataskip[107]=70;
				dataskip[111]=16;
				dataskip[112]=112;
				dataskip[115]=102;
				dataskip[116]=26;
				dataskip[120]=60;
				dataskip[121]=68;
				dataskip[125]=18;
				dataskip[126]=110;
				dataskip[129]=104;
				dataskip[130]=24;
				dataskip[134]=62;
				dataskip[135]=66;
				dataskip[139]=20;	
			}

			else if (module_name.indexOf("292e") == 0) {
				//292e is easy. First four characters are address, then 16 characters of data, 
				//then four more characters of address, another 16 and so on until the end.
				for (i = 0; i < 30; i++) {
					dataskip[i] = 16;
				}
			}
			
			else if (module_name.indexOf("Studio H 210e") == 0) {
				//Every line different in CSR. 
				
				//Note CSR data is packed. Each value is 12 bits, so bytes are shared to save space.  
				//Unpacking will be necessary if you want to edit the data. Packing would be necessary 
				//before writing the edited data back to the module. 
				//If no editing is needed, no need to unpack and pack. Just leave the data as received 
				//and send it back as it is.
				
				/* HERE IS THE PACK CODE USED BY THE MODULE. 
				   On the CSR, PRESET_LENGTH=70. PACKED_PRESET_LENGTH is 53.
				  //Pack data into packed_data.
				  //First get the nibbles into a byte array as the lower nibble in each byte
				  int j = 0;
				  for (int i=0;i<PRESET_LENGTH;i++){
					tmp_data[j] = 0 | ((data[i] & 0x000F));
					j++;
					tmp_data[j] = 0 | ((data[i] & 0x00F0) >> 4);
					j++;
					tmp_data[j] = 0 | ((data[i] & 0x0F00) >> 8);
					j++;
				  }
				  
				  //Now read all of the nibbles into the packed array
				  j = 0;
				  for (int i=0;i<PACKED_PRESET_LENGTH;i++){
					packed_data[i] = tmp_data[j] & 0x000F;
					j++;
					packed_data[i] = packed_data[i] | ((tmp_data[j] & 0x000F) << 4);
					j++;
					packed_data[i] = packed_data[i] | ((tmp_data[j] & 0x000F) << 8);
					j++;
					packed_data[i] = packed_data[i] | ((tmp_data[j] & 0x000F) << 12);
					j++;
				  }
				 */
							
				/* HERE IS THE UNPACK CODE USED BY THE MODULE. 
				   On the CSR, PRESET_LENGTH=70. PACKED_PRESET_LENGTH is 53.
				  //Unpack packed_data into data.
				  //First read the packed data nibbles into bytes
				  int j = 0;
				  for (int i=0;i<PACKED_PRESET_LENGTH;i++){
					tmp_data[j] = 0  | (packed_data[i] & 0x000F);
					j++;
					tmp_data[j] = 0  | ((packed_data[i] & 0x00F0) >> 4);
					j++;
					tmp_data[j] = 0  | ((packed_data[i] & 0x0F00) >> 8);
					j++;
					tmp_data[j] = 0  | ((packed_data[i] & 0xF000) >> 12);
					j++;
				  }

				  //Now read the nibbles into 12 bit words
				  j = 0;
				  for (int i=0;i<PRESET_LENGTH;i++){
					data[i] = 0 | tmp_data[j];
					j++;
					data[i] = data[i] | (tmp_data[j] << 4);
					j++;
					data[i] = data[i] | (tmp_data[j] << 8);
					j++; 
				  }	
				*/
				dataskip[0]=212;
				dataskip[1]=44;
				dataskip[2]=168;
				dataskip[3]=88;
				dataskip[4]=124;
				dataskip[5]=132;
				dataskip[6]=80;
				dataskip[7]=176;
				dataskip[8]=36;
				dataskip[9]=212;
				dataskip[10]=8;
				dataskip[11]=204;
				dataskip[12]=52;
				dataskip[13]=160;
				dataskip[14]=96;
				dataskip[15]=116;
				dataskip[16]=140;
				dataskip[17]=72;
				dataskip[18]=184;
				dataskip[19]=28;
				dataskip[20]=212;
				dataskip[21]=16;
				dataskip[22]=196;
				dataskip[23]=60;
				dataskip[24]=152;
				dataskip[25]=104;
				dataskip[26]=108;
				dataskip[27]=148;
				dataskip[28]=64;
				dataskip[29]=192;
				dataskip[30]=20;
				dataskip[31]=212;
				dataskip[32]=24;
				dataskip[33]=188;
				dataskip[34]=68;
				dataskip[35]=144;
				dataskip[36]=112;
				dataskip[37]=100;
				dataskip[38]=156;
				dataskip[39]=56;
				dataskip[40]=200;
				dataskip[41]=12;
				dataskip[42]=212;
				dataskip[43]=32;
				dataskip[44]=180;
				dataskip[45]=76;
				dataskip[46]=136;
				dataskip[47]=120;
				dataskip[48]=92;
				dataskip[49]=164;
				dataskip[50]=48;
				dataskip[51]=208;
				dataskip[52]=4;
				dataskip[53]=212;	
			}
			
			else if (module_name.indexOf("Studio H DPO") == 0) {
				//DPO is 64 per line. 
				for (i = 0; i < 30; i++) {
					dataskip[i] = 64;
				}
			}
			
			var rawdata = rawJsonMessage.data;	
			for (i = 0; i < dataskip.length; i++) {
				var memory_address = rawdata.substring(0,4);
				rawdata = rawdata.substring(4);
				var preset_data = rawdata.substring(0,dataskip[i]);
				rawdata = rawdata.substring(dataskip[i]);
				var presetDataElement = {
					addr : memory_address,
					data : preset_data
				}	
				presetData.push(presetDataElement);
			}


			if (presetData.length > 0) {
				var refinedJson = {
					module_address: module_address,
					module_name: module_name,
					presets : presetData
				}
				document.getElementById("result").innerHTML = JSON.stringify(refinedJson);
				
			}	
			
		}
		
		request.ontimeout = function (e) {
			// XMLHttpRequest timed out. 
			var textValue = document.getElementById("result").innerHTML;
			textValue = textValue + "Request timed out.<br/>"
			document.getElementById("result").innerHTML = textValue;
			
		};
	
		document.getElementById("button").onclick = function () {
			module_address = module.value;
			module_name = module.options[module.selectedIndex].text;
			document.getElementById("result").innerHTML = "Please select a module.<br/>";
			if (module_address != "Select") {
				url = url + module_address;
				request.open(method, url, shouldBeAsync);
				request.send(null);
				document.getElementById("result").innerHTML = "Sending request for presets at address " + module_address + "...<br/>";			
			}
		}; 
		
	</script>
</html>