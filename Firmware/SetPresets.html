<html>
	<body>
		<button onclick="input.click()">Browse for presets file.</button>
		<pre id="demo"></pre>
</div>
	</body>
	<script>
		//This script processes the selected JSON file and writes it to the device (writememory). 
		//It then instructs the module to read the presets from the device (setpresets).
		//The maximum POST size to writememory is 20k so data is split into parts if necessary.
		const MAX_JSON_PART_LENGTH = 18000; //Max bytes per POST to writememory.
		const JSON_DATA_ELEMENT_OVERHEAD = 26; //bytes used up for each data element by tag names, colons, etc.
		var input = document.createElement('input');
		input.type = 'file';
		input.accept = ".json";
		input.click();
		
		input.onchange = e => { 
			var file = e.target.files[0]; 		
			var reader = new FileReader();
			reader.readAsText(file,'UTF-8');
			reader.onload = readerEvent => {
				var jsonString = readerEvent.target.result; //json file contents as string
				var parsedJson = JSON.parse(jsonString);
				var module_address = parsedJson.module_address;
				var jsonParts = [];
				var jsonPart = [];
				jsonParts.push(jsonPart);
				var datacount = 0;
				for(var i = 0;i < parsedJson.presets.length;i++){
					jsonPart.push(parsedJson.presets[i]);
					datacount = datacount + parsedJson.presets[i].data.length;
					if ((datacount + JSON_DATA_ELEMENT_OVERHEAD  * jsonPart.length)> MAX_JSON_PART_LENGTH) {
						jsonPart = [];
						jsonParts.push(jsonPart);
						datacount = 0;
					}
				}
				var request = new XMLHttpRequest();
				for(var i = 0;i < jsonParts.length;i++){
					//Send each JSON part
					var jsonPartString = JSON.stringify(jsonParts[i],undefined,2);
					request.open("POST", "http://192.168.0.1/writememory", false); //Seems synchronous (false) is needed here, right?
					request.setRequestHeader("Content-Length", jsonPartString.length);
					request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
					request.send(jsonPartString);
				}
				var url = "http://192.168.0.1/setpresets?addr=" + module_address;
				request.open("GET", url, true);
				request.send(null);
				document.getElementById("demo").innerHTML = "Done.";
			}
		}		
	</script>
</html>
